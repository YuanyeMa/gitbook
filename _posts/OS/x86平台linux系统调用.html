
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>x86平台linux系统调用 · Yuanye Ma`s blog</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Yuanye Ma">
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search-pro/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-pageview-count/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-page-toc-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="x86平台通用中断.html" />
    
    
    <link rel="prev" href="submit-patch.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" >
            
                <span>
            
                    
                    Posts
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" >
            
                <span>
            
                    
                    Dev Env
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1" data-path="../devEnv/2019-05-15-在ubuntu上安装vnc服务.html">
            
                <a href="../devEnv/2019-05-15-在ubuntu上安装vnc服务.html">
            
                    
                    2019-05-15-在ubuntu上安装vnc服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.2" data-path="../devEnv/2019-07-24-配置jupyter-notebook服务.html">
            
                <a href="../devEnv/2019-07-24-配置jupyter-notebook服务.html">
            
                    
                    2019-07-24-配置jupyter-notebook服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3" data-path="../devEnv/2019-07-27-BreakWall.html">
            
                <a href="../devEnv/2019-07-27-BreakWall.html">
            
                    
                    2019 07 27 Break Wall
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.4" data-path="../devEnv/2019-11-05-记一次NVIDIA-Driver-cuda升级.html">
            
                <a href="../devEnv/2019-11-05-记一次NVIDIA-Driver-cuda升级.html">
            
                    
                    2019-11-05-记一次NVIDIA-Driver-cuda升级
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.5" data-path="../devEnv/2020-01-04-ubuntu%20部署NIS服务.md">
            
                <span>
            
                    
                    2020-01-04-ubuntu 部署NIS服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.6" data-path="../devEnv/2020-02-05-BreakWall-2%20V2ray.md">
            
                <span>
            
                    
                    2020 02 05 Break Wall 2 V 2 Ray
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.7" data-path="../devEnv/2020-03-08-omv.html">
            
                <a href="../devEnv/2020-03-08-omv.html">
            
                    
                    2020 03 08 Omv
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.8" data-path="../devEnv/2020-03-29-noVnc.html">
            
                <a href="../devEnv/2020-03-29-noVnc.html">
            
                    
                    2020 03 29 No Vnc
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.9" data-path="../devEnv/BreakWall-3-Trojan.html">
            
                <a href="../devEnv/BreakWall-3-Trojan.html">
            
                    
                    Break Wall 3 Trojan
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.10" data-path="../devEnv/gitbook.html">
            
                <a href="../devEnv/gitbook.html">
            
                    
                    Gitbook
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2" >
            
                <span>
            
                    
                    Diary
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.2.1" data-path="../diary/2017-01-14-回顾2016年.html">
            
                <a href="../diary/2017-01-14-回顾2016年.html">
            
                    
                    2017-01-14-回顾2016年
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.2" data-path="../diary/2019-01-04-2017考研年.html">
            
                <a href="../diary/2019-01-04-2017考研年.html">
            
                    
                    2019-01-04-2017考研年
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.3" data-path="../diary/2019-01-09-我的2018.html">
            
                <a href="../diary/2019-01-09-我的2018.html">
            
                    
                    2019-01-09-我的2018
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2.4" data-path="../diary/2019-01-25-写在大连回家路上.html">
            
                <a href="../diary/2019-01-25-写在大连回家路上.html">
            
                    
                    2019-01-25-写在大连回家路上
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.3" >
            
                <span>
            
                    
                    Hackintosh
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.3.1" data-path="../Hackintosh/2019-04-15-Hackintosh（黑苹果）.html">
            
                <a href="../Hackintosh/2019-04-15-Hackintosh（黑苹果）.html">
            
                    
                    2019-04-15-Hackintosh（黑苹果）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.2" data-path="../Hackintosh/2019-05-09-制作dmg格式的苹果镜像.html">
            
                <a href="../Hackintosh/2019-05-09-制作dmg格式的苹果镜像.html">
            
                    
                    2019-05-09-制作dmg格式的苹果镜像
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.3" data-path="../Hackintosh/2019-05-13-在黑苹果上部署开发环境.html">
            
                <a href="../Hackintosh/2019-05-13-在黑苹果上部署开发环境.html">
            
                    
                    2019-05-13-在黑苹果上部署开发环境
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3.4" data-path="../Hackintosh/2019-05-13-尝试吃黑苹果.html">
            
                <a href="../Hackintosh/2019-05-13-尝试吃黑苹果.html">
            
                    
                    2019-05-13-尝试吃黑苹果
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.4" >
            
                <span>
            
                    
                    LDD
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.4.1" data-path="../LDD/2020-10-05-Linux%20I2C子系统代码跟读.md">
            
                <span>
            
                    
                    2020-10-05-Linux I2C子系统代码跟读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.2" data-path="../LDD/2020-10-06-Linux设备驱动模型.html">
            
                <a href="../LDD/2020-10-06-Linux设备驱动模型.html">
            
                    
                    2020-10-06-Linux设备驱动模型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.3" data-path="../LDD/2020-10-06-platform总线驱动.html">
            
                <a href="../LDD/2020-10-06-platform总线驱动.html">
            
                    
                    2020-10-06-platform总线驱动
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.4" data-path="../LDD/2020-10-08-vim%20ctags cscope.md">
            
                <span>
            
                    
                    2020 10 08 Vim Ctags Cscope
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.5" data-path="../LDD/2020-10-09-loop设备的使用.html">
            
                <a href="../LDD/2020-10-09-loop设备的使用.html">
            
                    
                    2020-10-09-loop设备的使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.6" data-path="../LDD/2020-10-10-设备驱动基础.html">
            
                <a href="../LDD/2020-10-10-设备驱动基础.html">
            
                    
                    2020-10-10-设备驱动基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.7" data-path="../LDD/2020-10-11-linux驱动之LED驱动.html">
            
                <a href="../LDD/2020-10-11-linux驱动之LED驱动.html">
            
                    
                    2020-10-11-linux驱动之LED驱动
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.8" data-path="../LDD/2020-10-27-linux驱动之中断（按键驱动）.html">
            
                <a href="../LDD/2020-10-27-linux驱动之中断（按键驱动）.html">
            
                    
                    2020-10-27-linux驱动之中断（按键驱动）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.9" data-path="../LDD/input子系统.html">
            
                <a href="../LDD/input子系统.html">
            
                    
                    input子系统
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.10" data-path="../LDD/Kobject和sysfs.html">
            
                <a href="../LDD/Kobject和sysfs.html">
            
                    
                    Kobject和sysfs
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.11" data-path="../LDD/关于设备树.html">
            
                <a href="../LDD/关于设备树.html">
            
                    
                    关于设备树
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.5" >
            
                <span>
            
                    
                    OS
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.5.1" data-path="2019-07-05-X86汇编.html">
            
                <a href="2019-07-05-X86汇编.html">
            
                    
                    2019-07-05-X86汇编
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5.2" data-path="2020-01-15-x86汇编从实模式到保护模式实验.html">
            
                <a href="2020-01-15-x86汇编从实模式到保护模式实验.html">
            
                    
                    2020-01-15-x86汇编从实模式到保护模式实验
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5.3" data-path="GDT%20LDT IDT TSS.md">
            
                <span>
            
                    
                    GDT LDT IDT TSS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5.4" data-path="GNU%20C 嵌入汇编.md">
            
                <span>
            
                    
                    GNU C 嵌入汇编
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5.5" data-path="kzalloc%20& kmalloc.md">
            
                <span>
            
                    
                    Kzalloc Kmalloc
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5.6" data-path="Linux%20Kernel Makefiles.md">
            
                <span>
            
                    
                    Linux Kernel Makefiles
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5.7" data-path="linux%20kernel slab系统.md">
            
                <span>
            
                    
                    linux kernel slab系统
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5.8" data-path="Linux%20内核临时页表初始化.md">
            
                <span>
            
                    
                    Linux 内核临时页表初始化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5.9" data-path="Linux%20内核存储管理.md">
            
                <span>
            
                    
                    Linux 内核存储管理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5.10" data-path="submit-patch.html">
            
                <a href="submit-patch.html">
            
                    
                    Submit Patch
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.2.5.11" data-path="x86平台linux系统调用.html">
            
                <a href="x86平台linux系统调用.html">
            
                    
                    x86平台linux系统调用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5.12" data-path="x86平台通用中断.html">
            
                <a href="x86平台通用中断.html">
            
                    
                    x86平台通用中断
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5.13" data-path="编译内核文档.html">
            
                <a href="编译内核文档.html">
            
                    
                    编译内核文档
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.6" >
            
                <span>
            
                    
                    Others
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.6.1" data-path="../others/2019-01-04-Git-tag常用命令.html">
            
                <a href="../others/2019-01-04-Git-tag常用命令.html">
            
                    
                    2019-01-04-Git-tag常用命令
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6.2" data-path="../others/2019-01-04-Makefile中的一些神奇用法.html">
            
                <a href="../others/2019-01-04-Makefile中的一些神奇用法.html">
            
                    
                    2019-01-04-Makefile中的一些神奇用法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6.3" data-path="../others/2019-01-04-Shell中的source.html">
            
                <a href="../others/2019-01-04-Shell中的source.html">
            
                    
                    2019-01-04-Shell中的source
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6.4" data-path="../others/2019-01-04-Shell编程中变量引用方法.html">
            
                <a href="../others/2019-01-04-Shell编程中变量引用方法.html">
            
                    
                    2019-01-04-Shell编程中变量引用方法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6.5" data-path="../others/2019-06-04-C++%20Primer Plus笔记.md">
            
                <span>
            
                    
                    2019-06-04-C++ Primer Plus笔记
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6.6" data-path="../others/2019-07-20-tensorboardX的简单用法.html">
            
                <a href="../others/2019-07-20-tensorboardX的简单用法.html">
            
                    
                    2019-07-20-tensorboardX的简单用法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6.7" data-path="../others/2019-07-29-stl入门.html">
            
                <a href="../others/2019-07-29-stl入门.html">
            
                    
                    2019-07-29-stl入门
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6.8" data-path="../others/2019-08-06-C++继承.html">
            
                <a href="../others/2019-08-06-C++继承.html">
            
                    
                    2019-08-06-C++继承
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6.9" data-path="../others/uboot.html">
            
                <a href="../others/uboot.html">
            
                    
                    Uboot
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6.10" data-path="../others/基于Ubuntu进行STM32程序开发.html">
            
                <a href="../others/基于Ubuntu进行STM32程序开发.html">
            
                    
                    基于Ubuntu进行STM32程序开发
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.6.11" data-path="../others/跟我一起写Makefile笔记.html">
            
                <a href="../others/跟我一起写Makefile笔记.html">
            
                    
                    跟我一起写Makefile笔记
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.7" >
            
                <span>
            
                    
                    笔试题
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.7.1" data-path="../笔试题/2019-08-14-2019笔试题.html">
            
                <a href="../笔试题/2019-08-14-2019笔试题.html">
            
                    
                    2019-08-14-2019笔试题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7.2" data-path="../笔试题/2019-08-24-开发岗笔试基础题总结.html">
            
                <a href="../笔试题/2019-08-24-开发岗笔试基础题总结.html">
            
                    
                    2019-08-24-开发岗笔试基础题总结
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.7.3" data-path="../笔试题/2019-08-29-背包问题答题模板.html">
            
                <a href="../笔试题/2019-08-29-背包问题答题模板.html">
            
                    
                    2019-08-29-背包问题答题模板
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Draft
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../../draft/30天自制操作系统实验记录.html">
            
                <a href="../../draft/30天自制操作系统实验记录.html">
            
                    
                    30天自制操作系统实验记录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../../draft/关于系统调用.html">
            
                <a href="../../draft/关于系统调用.html">
            
                    
                    关于系统调用
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >x86平台linux系统调用</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="x86&#x5E73;&#x53F0;linux&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5206;&#x6790;">x86&#x5E73;&#x53F0;linux&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5206;&#x6790;</h1>
<p>[toc]</p>
<p>kernel version : linux 2.6.30.4 </p>
<h2 id="x86-&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6574;&#x4F53;&#x6D41;&#x7A0B;">x86 &#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6574;&#x4F53;&#x6D41;&#x7A0B;</h2>
<p><img src="http://chenweixiang.github.io/assets/System_Call_Procedure.jpg" alt="chenweixiang.github.io&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7AE0;&#x8282;"></p>
<p>&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x8C03;&#x7528;<code>libc</code>&#x5E93;&#x7684;<code>syscall</code>&#x51FD;&#x6570;&#xFF0C;&#x6B64;&#x51FD;&#x6570;&#x5185;&#x5D4C;&#x6C47;&#x7F16;&#xFF0C;&#x6C47;&#x7F16;&#x4EE3;&#x7801;&#x5148;&#x5C06;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;&#x5199;&#x5165;<code>eax</code>&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x5176;&#x4ED6;&#x53C2;&#x6570;&#x5199;&#x5165;<code>ebx ecx edx esi edi</code>&#x4E94;&#x4E2A;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x82E5;&#x53C2;&#x6570;&#x603B;&#x4E2A;&#x6570;&#x8D85;&#x8FC7;&#x4E94;&#x4E2A;&#xFF0C;&#x5219;&#x5E94;&#x8BE5;&#x7528;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x5B58;&#x653E;&#x6307;&#x5411;&#x6240;&#x6709;&#x8FD9;&#x4E9B;&#x53C2;&#x6570;&#x5728;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x5730;&#x5740;&#x7684;&#x6307;&#x9488;&#x3002;&#x7136;&#x540E;&#x8C03;&#x7528;<code>int 0x80</code>&#x6307;&#x4EE4;&#x9677;&#x5165;&#x5185;&#x6838;&#x3002;</p>
<p><img src="../../images/20201123/system_call_process.png" alt="system_call_process"></p>
<p>CPU&#x4ECE;<code>IDTR</code>&#x4E2D;&#x5F97;&#x5230;<code>IDT</code>&#xFF08;&#x4E2D;&#x65AD;&#x5411;&#x91CF;&#x8868;&#xFF09;&#x5730;&#x5740;&#xFF0C;&#x5E76;&#x6839;&#x636E;&#x4E2D;&#x65AD;&#x53F7;(0x80)&#x627E;&#x5230;<code>IDT</code>&#x4E0B;&#x6807;&#x4E3A;<code>0x80</code>&#x7684;&#x5143;&#x7D20;&#xFF0C;&#x5373;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x68C0;&#x67E5;<code>CPL=3</code>, &#x95E8;&#x63CF;&#x8FF0;&#x7B26;<code>DPL=0</code>&#xFF0C;&#x4E0D;&#x76F8;&#x7B26;&#xFF0C;&#x53D1;&#x751F;&#x6808;&#x5207;&#x6362;&#x3002;</p>
<p>CPU&#x6839;&#x636E;&#x5BC4;&#x5B58;&#x5668;<code>TR</code>&#x7684;&#x5185;&#x5BB9;&#x627E;&#x5230;&#x5F53;&#x524D;<code>TSS</code>,&#x5E76;&#x6839;&#x636E;&#x76EE;&#x6807;&#x4EE3;&#x7801;&#x6BB5;&#x7684;<code>DPL</code>&#xFF0C;&#x4ECE;<code>TSS</code>&#x7ED3;&#x6784;&#x4E2D;&#x53D6;&#x51FA;&#x65B0;&#x7684;&#x5806;&#x6808;&#x6307;&#x9488;&#xFF08;SS&#x548C;ESP&#xFF09;&#xFF0C;&#x5E76;&#x88C5;&#x5165;&#x5176;&#x5806;&#x6808;&#x6BB5;&#x5BC4;&#x5B58;&#x5668;<code>SS</code>&#x548C;&#x5806;&#x6808;&#x6307;&#x9488;<code>ESP</code>&#x4E2D;&#xFF0C;&#x8FBE;&#x5230;&#x66F4;&#x6362;&#x5806;&#x6808;&#x7684;&#x76EE;&#x7684;&#x3002;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;CPU&#x4E0D;&#x4F46;&#x8981;&#x5C06;<code>EFLAGS</code>&#x3001;&#x8FD4;&#x56DE;&#x5730;&#x5740;&#x4EE5;&#x53CA;&#x51FA;&#x9519;&#x4EE3;&#x7801;&#x538B;&#x5165;&#x5806;&#x6808;&#xFF0C;&#x8FD8;&#x8981;&#x5148;&#x5C06;&#x539F;&#x6765;&#x7684;&#x5806;&#x6808;&#x6307;&#x9488;&#x4E5F;&#x538B;&#x5165;&#x65B0;&#x5806;&#x6808;&#x4E2D;&#x3002;</p>
<p><img src="../../images/20201123/stack_sw.png" alt="stack_sw"></p>
<p>&#x6808;&#x5207;&#x6362;&#x5B8C;&#x6210;&#x540E;&#xFF0C;CPU&#x4ECE;&#x9677;&#x9631;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#x4E2D;&#x627E;&#x5230;&#x4E2D;&#x65AD;&#x670D;&#x52A1;&#x7A0B;&#x5E8F;&#x6240;&#x5728;&#x5185;&#x5B58;&#x6BB5;&#x7684;&#x6BB5;&#x9009;&#x62E9;&#x5B50;&#x548C;&#x5730;&#x5740;&#x504F;&#x79FB;&#xFF0C;&#x6839;&#x636E;&#x6BB5;&#x9009;&#x62E9;&#x5B50;&#x53BB;<code>GDT</code>&#x6216;&#x8005;<code>LDT</code>&#x4E2D;&#x627E;&#x5230;&#x5BF9;&#x5E94;&#x7684;&#x6BB5;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x88C5;&#x5165;<code>CS</code>&#x6BB5;&#x9009;&#x62E9;&#x5BC4;&#x5B58;&#x5668;&#xFF0C;&#x627E;&#x5230;&#x6BB5;&#x57FA;&#x5730;&#x5740;&#xFF0C;&#x5E76;&#x52A0;&#x4E0A;&#x5730;&#x5740;&#x504F;&#x79FB;&#x540E;&#x627E;&#x5230;&#x4E2D;&#x65AD;&#x670D;&#x52A1;&#x7A0B;&#x5E8F;&#x5165;&#x53E3;&#x5730;&#x5740;&#xFF0C;&#x8DF3;&#x8F6C;&#x8FC7;&#x53BB;&#x8FD0;&#x884C;&#x3002;</p>
<h2 id="&#x4E2D;&#x65AD;&#x5411;&#x91CF;&#x8868;idt&#x7684;&#x521D;&#x59CB;&#x5316;">&#x4E2D;&#x65AD;&#x5411;&#x91CF;&#x8868;IDT&#x7684;&#x521D;&#x59CB;&#x5316;</h2>
<p>&#x57FA;&#x4E8E;<code>linux 2.6.30.4</code></p>
<pre><code class="lang-c"><span class="hljs-comment">/* &quot;arch/x86/kernel/traps.c&quot; */</span>
<span class="hljs-keyword">void</span> __<span class="hljs-function">init <span class="hljs-title">trap_init</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{    
        set_intr_gate(<span class="hljs-number">0</span>, &amp;divide_error);
        set_intr_gate_ist(<span class="hljs-number">1</span>, &amp;debug, DEBUG_STACK);
        set_intr_gate_ist(<span class="hljs-number">2</span>, &amp;nmi, NMI_STACK);
        <span class="hljs-comment">/* int3 can be called from all */</span>
        set_system_intr_gate_ist(<span class="hljs-number">3</span>, &amp;int3, DEBUG_STACK);
        <span class="hljs-comment">/* int4 can be called from all */</span>
        set_system_intr_gate(<span class="hljs-number">4</span>, &amp;overflow);
        set_intr_gate(<span class="hljs-number">5</span>, &amp;bounds);
        set_intr_gate(<span class="hljs-number">6</span>, &amp;invalid_op);
        set_intr_gate(<span class="hljs-number">7</span>, &amp;device_not_available);

        set_task_gate(<span class="hljs-number">8</span>, GDT_ENTRY_DOUBLEFAULT_TSS);
        set_intr_gate(<span class="hljs-number">9</span>, &amp;coprocessor_segment_overrun);
        set_intr_gate(<span class="hljs-number">10</span>, &amp;invalid_TSS);
        set_intr_gate(<span class="hljs-number">11</span>, &amp;segment_not_present);
        set_intr_gate_ist(<span class="hljs-number">12</span>, &amp;stack_segment, STACKFAULT_STACK);
        set_intr_gate(<span class="hljs-number">13</span>, &amp;general_protection);
        set_intr_gate(<span class="hljs-number">14</span>, &amp;page_fault);
        set_intr_gate(<span class="hljs-number">15</span>, &amp;spurious_interrupt_bug);
        set_intr_gate(<span class="hljs-number">16</span>, &amp;coprocessor_error);
        set_intr_gate(<span class="hljs-number">17</span>, &amp;alignment_check);

        set_system_trap_gate(SYSCALL_VECTOR, &amp;system_call);
    <span class="hljs-comment">/*
    SYSCALL_VECTOR
    arch/x86/include/asm/irq_vectors.h:36:# define SYSCALL_VECTOR                   0x80
    asmlinkage int system_call(void);
    */</span>

        cpu_init();        
}
</code></pre>
<p>&#x7A0B;&#x5E8F;&#x4E2D;&#x9996;&#x5148;&#x8BBE;&#x7F6E;&#x4E2D;&#x65AD;&#x5411;&#x91CF;&#x8868;&#x7684;&#x5934;19&#x4E2A;&#x9677;&#x9631;&#x95E8;&#xFF0C;&#x8FD9;&#x4E9B;&#x4E2D;&#x65AD;&#x5411;&#x91CF;&#x8868;&#x90FD;&#x662F;CPU&#x4FDD;&#x7559;&#x7528;&#x4E8E;&#x5F02;&#x5E38;&#x5904;&#x7406;&#x7684;&#x3002;</p>
<p><code>set_intr_gate()</code> &#x7B49;&#x51FD;&#x6570;&#x90FD;&#x8C03;&#x7528;&#x4E86;<code>_set_gate()</code>&#x51FD;&#x6570;&#x8BBE;&#x7F6E;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#xFF0C;&#x672C;&#x6587;&#x91CD;&#x70B9;&#x5206;&#x6790;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x76F8;&#x5173;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x5373; <code>set_system_trap_gate()</code>&#x51FD;&#x6570;&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-comment">/*&quot;arch/x86/include/asm/desc.h&quot; */</span>

<span class="hljs-comment">/* 
    set_system_trap_gate(SYSCALL_VECTOR, &amp;system_call); 
    &#x53C2;&#x6570;
            n = SYSCALL_VECTOR = 0x80;
            addr = &amp;system_call
*/</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">set_system_trap_gate</span><span class="hljs-params">(<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> n, <span class="hljs-keyword">void</span> *addr)</span>
</span>{
        BUG_ON((<span class="hljs-keyword">unsigned</span>)n &gt; <span class="hljs-number">0xFF</span>);
        _set_gate(n, GATE_TRAP, addr, <span class="hljs-number">0x3</span>, <span class="hljs-number">0</span>, __KERNEL_CS);
}
</code></pre>
<p><code>_set_gate()</code>&#x51FD;&#x6570;&#x5B8C;&#x6210;&#x8BBE;&#x7F6E;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#x7684;&#x5DE5;&#x4F5C;&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-comment">/* 
    _set_gate(n, GATE_TRAP, addr, 0x3, 0, __KERNEL_CS); 
    &quot;arch/x86/include/asm/desc_defs.h&quot;    
        enum {
                GATE_INTERRUPT = 0xE,
                GATE_TRAP = 0xF,
                GATE_CALL = 0xC,
                GATE_TASK = 0x5,
        };
    arch/x86/include/asm/segment.h 
            #define __KERNEL_CS     (GDT_ENTRY_KERNEL_CS * 8)
            #define GDT_ENTRY_KERNEL_CS 2
*/</span>

<span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> _set_gate(<span class="hljs-keyword">int</span> gate, <span class="hljs-keyword">unsigned</span> type, <span class="hljs-keyword">void</span> *addr,
                             <span class="hljs-keyword">unsigned</span> dpl, <span class="hljs-keyword">unsigned</span> ist, <span class="hljs-keyword">unsigned</span> seg)
{
    <span class="hljs-comment">/*
    &#x53C2;&#x6570;&#x5982;&#x4E0B;&#xFF1A;
        gate = n = SYSCALL_VECTOR = 0x80;
        type = GATE_TRAP = 0xF;
        addr = &amp;system_call;
        dpl = 0x3;
        ist = 0;
        seg = __KERNEL_CS = 2*8;
    */</span>
        gate_desc s;
        pack_gate(&amp;s, type, (<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span>)addr, dpl, ist, seg);
        <span class="hljs-comment">/*
         * does not need to be atomic because it is only done once at
         * setup time
         */</span>
        write_idt_entry(idt_table, gate, &amp;s);
}
</code></pre>
<p><img src="../../images/20201123/trap_gate.png" alt="trap_gate"></p>
<p>&#x5148;&#x770B;&#x770B;&#x7B2C;&#x4E00;&#x884C;<code>gate_desc s;</code>&#xFF0C;&#x4E3B;&#x8981;&#x5206;&#x914D;&#x4E86;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#x7684;&#x7ED3;&#x6784;&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-comment">/*gate_desc &#x7ED3;&#x6784; &quot;arch/x86/include/asm/desc_defs.h&quot; */</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-keyword">struct</span> desc_struct gate_desc;
<span class="hljs-keyword">struct</span> desc_struct {
        <span class="hljs-keyword">union</span> {
                <span class="hljs-keyword">struct</span> {
                        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> a; <span class="hljs-comment">// 4&#x5B57;&#x8282;</span>
                        <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> b; <span class="hljs-comment">// 4&#x5B57;&#x8282;</span>
                };
                <span class="hljs-keyword">struct</span> {
                        u16 limit0; <span class="hljs-comment">// 2&#x5B57;&#x8282; &#x4F4D;&#x79FB;&#x7684;&#x4F4E;16&#x4F4D;</span>
                        u16 base0;  <span class="hljs-comment">// 2&#x5B57;&#x8282; &#x6BB5;&#x9009;&#x62E9;&#x7801;</span>
                        <span class="hljs-keyword">unsigned</span> base1: <span class="hljs-number">8</span>, type: <span class="hljs-number">4</span>, s: <span class="hljs-number">1</span>, dpl: <span class="hljs-number">2</span>, p: <span class="hljs-number">1</span>; <span class="hljs-comment">// 2&#x5B57;&#x8282;</span>
                        <span class="hljs-keyword">unsigned</span> limit: <span class="hljs-number">4</span>, avl: <span class="hljs-number">1</span>, l: <span class="hljs-number">1</span>, d: <span class="hljs-number">1</span>, g: <span class="hljs-number">1</span>, base2: <span class="hljs-number">8</span>; <span class="hljs-comment">//2&#x5B57;&#x8282;</span>
                };
        };
} __attribute__((packed));
</code></pre>
<blockquote>
<p><strong>attribute</strong> ((packed)) &#x7684;&#x4F5C;&#x7528;&#x5C31;&#x662F;&#x544A;&#x8BC9;&#x7F16;&#x8BD1;&#x5668;&#x53D6;&#x6D88;&#x7ED3;&#x6784;&#x5728;&#x7F16;&#x8BD1;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x4F18;&#x5316;&#x5BF9;&#x9F50;,&#x6309;&#x7167;&#x5B9E;&#x9645;&#x5360;&#x7528;&#x5B57;&#x8282;&#x6570;&#x8FDB;&#x884C;&#x5BF9;&#x9F50;&#xFF0C;&#x662F;GCC&#x7279;&#x6709;&#x7684;&#x8BED;&#x6CD5;&#x3002;&#x8FD9;&#x4E2A;&#x529F;&#x80FD;&#x662F;&#x8DDF;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x6CA1;&#x5173;&#x7CFB;&#xFF0C;&#x8DDF;&#x7F16;&#x8BD1;&#x5668;&#x6709;&#x5173;&#xFF0C;gcc&#x7F16;&#x8BD1;&#x5668;&#x4E0D;&#x662F;&#x7D27;&#x51D1;&#x6A21;&#x5F0F;&#x7684;&#xFF0C;&#x5728;windows&#x4E0B;&#xFF0C;&#x7528;vc&#x7684;&#x7F16;&#x8BD1;&#x5668;&#x4E5F;&#x4E0D;&#x662F;&#x7D27;&#x51D1;&#x7684;&#xFF0C;&#x7528;tc&#x7684;&#x7F16;&#x8BD1;&#x5668;&#x5C31;&#x662F;&#x7D27;&#x51D1;&#x7684;&#x3002;  </p>
<p>&#x4F8B;&#x5982;&#xFF1A;  </p>
<p>&#x5728;TC&#x4E0B;&#xFF1A;struct my{ char ch; int a;} sizeof(int)=2;sizeof(my)=3;&#xFF08;&#x7D27;&#x51D1;&#x6A21;&#x5F0F;&#xFF09;<br>&#x5728;GCC&#x4E0B;&#xFF1A;struct my{ char ch; int a;} sizeof(int)=4;sizeof(my)=8;&#xFF08;&#x975E;&#x7D27;&#x51D1;&#x6A21;&#x5F0F;&#xFF09;<br>&#x5728;GCC&#x4E0B;&#xFF1A;struct my{ char ch; int a;}<strong>attrubte</strong> ((packed)) sizeof(int)=4;sizeof(my)=5  </p>
</blockquote>
<p><code>struct desc_struct</code>&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x8054;&#x5408;&#x4F53;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x5176;&#x4E2D;&#x4EFB;&#x4F55;&#x4E00;&#x79CD;&#x7C7B;&#x578B;&#xFF0C;&#x540E;&#x8FB9;&#x53EF;&#x4EE5;&#x770B;&#x5230;<code>pack_gate()</code>&#x51FD;&#x6570;&#x4F7F;&#x7528;&#x8054;&#x5408;&#x4F53;&#x4E2D;&#x7684;&#x7B2C;&#x4E00;&#x79CD;&#xFF0C;&#x5373;<code>struct {unsigned int a; unsigned  int b};</code>&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-comment">/* 
&#x53C2;&#x6570;
    gate = n = SYSCALL_VECTOR = 0x80;
    type = GATE_TRAP = 0xF;
    addr = &amp;system_call;
    dpl = 0x3;
    ist = 0;
    seg = __KERNEL_CS = 2*8;
*/</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">pack_gate</span><span class="hljs-params">(gate_desc *gate, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> type,
                             <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> base, <span class="hljs-keyword">unsigned</span> dpl, <span class="hljs-keyword">unsigned</span> flags,
                             <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span> seg)</span>
</span>{
        gate-&gt;a = (seg &lt;&lt; <span class="hljs-number">16</span>) | (base &amp; <span class="hljs-number">0xffff</span>);
        gate-&gt;b = (base &amp; <span class="hljs-number">0xffff0000</span>) |
                  (((<span class="hljs-number">0x80</span> | type | (dpl &lt;&lt; <span class="hljs-number">5</span>)) &amp; <span class="hljs-number">0xff</span>) &lt;&lt; <span class="hljs-number">8</span>);
}
</code></pre>
<p><code>pack_gate()</code>&#x6B64;&#x51FD;&#x6570;&#x5305;&#x88C5;&#x4E00;&#x4E2A;&#x9677;&#x9631;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#x3002;<code>gate-&gt;a</code>&#x5728;&#x4F4E;&#x5730;&#x5740;&#x3002;</p>
<blockquote>
<pre><code>/*
gate-&gt;a = (seg &lt;&lt; 16) | (base &amp; 0xffff);
gate-&gt;a = ((2*8)&lt;&lt;16 | (&amp;system_call &amp; 0xffff);
(&amp;system_call &amp; 0xffff) : &#x4E2D;&#x65AD;&#x670D;&#x52A1;&#x51FD;&#x6570;&#x5730;&#x5740;&#x6BB5;&#x5185;&#x504F;&#x79FB;&#x7684;&#x4F4E;16&#x4F4D;
((2*8)&lt;&lt;16  : &#x6BB5;&#x9009;&#x62E9;&#x7801;&#xFF0C;&#x5373;&#x4E2D;&#x65AD;&#x670D;&#x52A1;&#x51FD;&#x6570;&#x6240;&#x5728;&#x4EE3;&#x7801;&#x6BB5;&#x9009;&#x62E9;&#x5B50;&#x5728;GTD&#x6216;&#x8005;LDT&#x4E2D;&#x7684;&#x4E0B;&#x6807;&#x3002;

gate-&gt;b = (base &amp; 0xffff0000) | (((0x80 | type | (dpl &lt;&lt; 5)) &amp; 0xff) &lt;&lt; 8);
gate-&gt;b = (&amp;system_call &amp; 0xffff0000) | (((0x80 | 0xF  | (0x3 &lt;&lt; 5)) &amp; 0xff) &lt;&lt; 8)
&#x89E3;&#x6790;
0x80 : 1000 0000
0xf  : 0000 1111
0x3  : 0000 0011
0xff : 1111 1111

0x80 | 0xF = 0x8f : 1000 1111
0x3 &lt;&lt; 5 = 0110 0000
(0x80 | 0xF  | (0x3 &lt;&lt; 5)) = 1110 1111
((0x80 | 0xF  | (0x3 &lt;&lt; 5)) &amp; 0xff) = 1110 1111
(((0x80 | 0xF  | (0x3 &lt;&lt; 5)) &amp; 0xff) &lt;&lt; 8) = 1110 1111 0000 0000
&#x5BF9;&#x5E94;&#x5230;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;
    (&amp;system_call &amp; 0xffff0000) : &#x4E2D;&#x65AD;&#x670D;&#x52A1;&#x51FD;&#x6570;&#x5730;&#x5740;&#x6BB5;&#x5185;&#x504F;&#x79FB;&#x7684;&#x9AD8;16&#x4F4D;
    P &#xFF1A; 1 &#xFF1A; &#x5185;&#x5B58;&#x6BB5;&#x5728;&#x5185;&#x5B58;&#x4E2D;
    DPL &#xFF1A; 11 &#xFF1A;DPL = 3
    0 &#xFF1A; &#x6C38;&#x8FDC;&#x4E3A;0
    D &#xFF1A; 1 &#x8868;&#x793A;32&#x4F4D;
    111 &#xFF1A; &#x7C7B;&#x578B;&#x7801; &#xFF1A; &#x9677;&#x9631;&#x95E8;
*/
</code></pre></blockquote>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> write_idt_entry(dt, entry, g)           \
        native_write_idt_entry(dt, entry, g)</span>

<span class="hljs-comment">/*
&#x53C2;&#x6570;
    idt = idt_table;
    entry = gate = n = SYSCALL_VECTOR = 0x80;;
    gate = &amp;s&#xFF1B;
&#x5176;&#x4E2D;
    gate_desc idt_table[256] 
            __attribute__((__section__(&quot;.data.idt&quot;))) = { { { { 0, 0 } } }, };

    typedef struct desc_struct gate_desc;
*/</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> <span class="hljs-title">native_write_idt_entry</span><span class="hljs-params">(gate_desc *idt, <span class="hljs-keyword">int</span> entry,
                                          <span class="hljs-keyword">const</span> gate_desc *gate)</span>
</span>{
        <span class="hljs-built_in">memcpy</span>(&amp;idt[entry], gate, <span class="hljs-keyword">sizeof</span>(*gate));
}
</code></pre>
<p><code>native_write_idt_entry()</code>&#x6B64;&#x51FD;&#x6570;&#x5C06;<code>pack_gate()</code>&#x51FD;&#x6570;&#x5C01;&#x88C5;&#x7684;&#x9677;&#x9631;&#x95E8;&#x63CF;&#x8FF0;&#x7B26;&#x62F7;&#x8D1D;&#x8FDB;<code>idt</code>&#x7684;0x80&#x4F4D;&#x7F6E;&#x3002;</p>
<h2 id="&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x4E2D;&#x65AD;&#x670D;&#x52A1;&#x7A0B;&#x5E8F;&#x5206;&#x6790;">&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x4E2D;&#x65AD;&#x670D;&#x52A1;&#x7A0B;&#x5E8F;&#x5206;&#x6790;</h2>
<pre><code class="lang-assembly">/*arch/x86/kernel/entry_32.S*/

        # system call handler stub
ENTRY(system_call)
        RING0_INT_FRAME                 # can&apos;t unwind into user space anyway
        pushl %eax                      # save orig_eax
        CFI_ADJUST_CFA_OFFSET 4
        SAVE_ALL
        GET_THREAD_INFO(%ebp)            # system call tracing in operation / emulation
        testl $_TIF_WORK_SYSCALL_ENTRY,TI_flags(%ebp)
        jnz syscall_trace_entry
        cmpl $(nr_syscalls), %eax
        jae syscall_badsys
syscall_call:
        call *sys_call_table(,%eax,4)
        movl %eax,PT_EAX(%esp)          # store the return value
syscall_exit:
        LOCKDEP_SYS_EXIT
        DISABLE_INTERRUPTS(CLBR_ANY)    # make sure we don&apos;t miss an interrupt
                                        # setting need_resched or sigpending
                                        # between sampling and the iret
        TRACE_IRQS_OFF
        movl TI_flags(%ebp), %ecx
        testl $_TIF_ALLWORK_MASK, %ecx  # current-&gt;work
        jne syscall_exit_work
</code></pre>
<p>&#x5148;&#x5C06;<code>%eax</code>&#xFF08;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;&#xFF09;&#x538B;&#x5165;&#x6808;&#xFF0C;&#x7136;&#x540E;&#x8C03;&#x7528;<code>SAVE_ALL</code>&#x4FDD;&#x5B58;&#x4E2D;&#x65AD;&#x73B0;&#x573A;&#xFF0C;&#x68C0;&#x67E5;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;&#xFF0C;&#x8DF3;&#x8F6C;&#x5230;&#x76F8;&#x5E94;&#x7684;&#x800C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x51FD;&#x6570;&#x53BB;&#x6267;&#x884C;<code>call *sys_call_table(,%eax,4)</code>&#xFF0C;<code>sys_call_table</code>&#x5B9A;&#x4E49;&#x5982;&#x4E0B;&#xFF0C;&#x662F;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x6307;&#x9488;&#x5217;&#x8868;&#x3002;</p>
<pre><code class="lang-assembly">/*arch/x86/kernel/syscall_table_32.S*/
ENTRY(sys_call_table)
        .long sys_restart_syscall       /* 0 - old &quot;setup()&quot; system call, used for restarting */
        .long sys_exit
        .long ptregs_fork
        .long sys_read
        .long sys_write
        .long sys_open          /* 5 */
        .long sys_close
        .long sys_waitpid
        .long sys_creat
        .long sys_link
        .long sys_unlink        /* 10 */
        .long ptregs_execve
        .long sys_chdir
        .long sys_time
        /* &#x7565; */
</code></pre>
<p>&#x5173;&#x4E8E;<code>SAVE_ALL</code></p>
<pre><code class="lang-assembly">.macro SAVE_ALL
        cld
        PUSH_GS
        pushl %fs
        CFI_ADJUST_CFA_OFFSET 4  # &#x8FD9;&#x4E9B;&#x5B8F;&#x6682;&#x65F6;&#x4E0D;&#x77E5;&#x9053;&#x5E72;&#x5565;&#x7684; 
        /*CFI_REL_OFFSET fs, 0;*/
        pushl %es
        CFI_ADJUST_CFA_OFFSET 4
        /*CFI_REL_OFFSET es, 0;*/
        pushl %ds
        CFI_ADJUST_CFA_OFFSET 4
        /*CFI_REL_OFFSET ds, 0;*/
        pushl %eax
        CFI_ADJUST_CFA_OFFSET 4
        CFI_REL_OFFSET eax, 0
        pushl %ebp
        CFI_ADJUST_CFA_OFFSET 4
        CFI_REL_OFFSET ebp, 0
        pushl %edi
        CFI_ADJUST_CFA_OFFSET 4
        CFI_REL_OFFSET edi, 0
        pushl %esi
        CFI_ADJUST_CFA_OFFSET 4
        CFI_REL_OFFSET esi, 0
        pushl %edx
        CFI_ADJUST_CFA_OFFSET 4
        CFI_REL_OFFSET edx, 0
        pushl %ecx
        CFI_ADJUST_CFA_OFFSET 4
        CFI_REL_OFFSET ecx,
        pushl %ebx
        CFI_ADJUST_CFA_OFFSET 4
        CFI_REL_OFFSET ebx, 0
        movl $(__USER_DS), %edx
        movl %edx, %ds
        movl %edx, %es
        movl $(__KERNEL_PERCPU), %edx
        movl %edx, %fs
        SET_KERNEL_GS %edx
.endm
</code></pre>
<p>&#x7A7F;&#x63D2;&#x4E00;&#x4E9B;&#x5B8F;&#x6682;&#x65F6;&#x4E0D;&#x77E5;&#x9053;&#x5E72;&#x4EC0;&#x4E48;&#x7684;&#xFF0C;&#x5148;&#x4E0D;&#x7BA1;&#x3002;&#x4E3B;&#x8981;&#x770B;&#x4E00;&#x4E0B;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x538B;&#x6808;&#x987A;&#x5E8F;&#xFF1A;<code>%es %ds %eax %ebp %edi %esi %edx %ecx %ebx</code></p>
<p><img src="../../images/20201123/stack_status.png" alt="image-stack_status"></p>
<h2 id="&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x5B9A;&#x4E49;">&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x5B9A;&#x4E49;</h2>
<pre><code class="lang-c"><span class="hljs-comment">/* include/linux/syscalls.h */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SYSCALL_DEFINE0(sname)                                  \
        static const struct syscall_metadata __used             \
          __attribute__((__aligned__(4)))                       \
          __attribute__((section(<span class="hljs-string">&quot;__syscalls_metadata&quot;</span>)))       \
          __syscall_meta_##sname = {                            \
                .name           = <span class="hljs-string">&quot;sys_&quot;</span>#sname,                 \
                .nb_args        = 0,                            \
        };                                                      \
        asmlinkage long sys_##sname(void)</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SYSCALL_DEFINE0(name)      asmlinkage long sys_##name(void)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SYSCALL_DEFINE1(name, ...) SYSCALL_DEFINEx(1, _##name, __VA_ARGS__)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SYSCALL_DEFINE2(name, ...) SYSCALL_DEFINEx(2, _##name, __VA_ARGS__)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SYSCALL_DEFINE3(name, ...) SYSCALL_DEFINEx(3, _##name, __VA_ARGS__)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SYSCALL_DEFINE4(name, ...) SYSCALL_DEFINEx(4, _##name, __VA_ARGS__)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SYSCALL_DEFINE5(name, ...) SYSCALL_DEFINEx(5, _##name, __VA_ARGS__)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SYSCALL_DEFINE6(name, ...) SYSCALL_DEFINEx(6, _##name, __VA_ARGS__)</span>

<span class="hljs-comment">/* &#x5176;&#x4E2D; SYSCALL_DEFINEx*/</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> CONFIG_FTRACE_SYSCALLS <span class="hljs-comment">/*ftrace&#x662F;&#x5185;&#x6838;&#x63D0;&#x4F9B;&#x7684;&#x4E00;&#x79CD;&#x8C03;&#x8BD5;&#x5DE5;&#x5177;*/</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SYSCALL_DEFINEx(x, sname, ...)                          \
        static const char *types_##sname[] = {                  \
                __SC_STR_TDECL##x(__VA_ARGS__)                  \
        };                                                      \
        static const char *args_##sname[] = {                   \
                __SC_STR_ADECL##x(__VA_ARGS__)                  \
        };                                                      \
        SYSCALL_METADATA(sname, x);                             \
        __SYSCALL_DEFINEx(x, sname, __VA_ARGS__)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SYSCALL_DEFINEx(x, sname, ...)                          \
        __SYSCALL_DEFINEx(x, sname, __VA_ARGS__)</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> CONFIG_HAVE_SYSCALL_WRAPPERS</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SYSCALL_DEFINE(name) static inline long SYSC_##name</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __SYSCALL_DEFINEx(x, name, ...)                                 \
        asmlinkage long sys##name(__SC_DECL##x(__VA_ARGS__));           \
        static inline long SYSC##name(__SC_DECL##x(__VA_ARGS__));       \
        asmlinkage long SyS##name(__SC_LONG##x(__VA_ARGS__))            \
        {                                                               \
                __SC_TEST##x(__VA_ARGS__);                              \
                return (long) SYSC##name(__SC_CAST##x(__VA_ARGS__));    \
        }                                                               \
        SYSCALL_ALIAS(sys##name, SyS##name);                            \
        static inline long SYSC##name(__SC_DECL##x(__VA_ARGS__))</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span> <span class="hljs-comment">/* CONFIG_HAVE_SYSCALL_WRAPPERS */</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SYSCALL_DEFINE(name) asmlinkage long sys_##name</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __SYSCALL_DEFINEx(x, name, ...)                                 \
        asmlinkage long sys##name(__SC_DECL##x(__VA_ARGS__))</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">/* CONFIG_HAVE_SYSCALL_WRAPPERS */</span></span>

<span class="hljs-comment">/* &#x540E;&#x8FB9;&#x662F;&#x6240;&#x6709;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x51FD;&#x6570;&#x58F0;&#x660E; */</span>
<span class="hljs-function">asmlinkage <span class="hljs-keyword">long</span> <span class="hljs-title">sys_time</span><span class="hljs-params">(time_t __user *tloc)</span></span>;
</code></pre>
<p>&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x5B9A;&#x4E49;&#x5206;&#x5E03;&#x5728;&#x5185;&#x6838;&#x6E90;&#x4EE3;&#x7801;&#x591A;&#x4E2A;&#x6E90;&#x6587;&#x4EF6;&#x4E2D;<code>find . -type f -name &quot;*.c&quot; | xargs grep SYSCALL_DEFINE | wc -l</code></p>
<h2 id="&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;">&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;</h2>
<p>&#x6BCF;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;<code>xxx</code>&#x90FD;&#x5BF9;&#x5E94;&#x7740;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;<code>__NR_xxx</code>&#x3002;&#x5F53;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8C03;&#x7528;&#x67D0;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x65F6;&#xFF0C;&#x5BC4;&#x5B58;&#x5668;eax&#x4E2D;&#x4FDD;&#x5B58;&#x8BE5;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5BF9;&#x5E94;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;&#x3002;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;&#x5B9A;&#x4E49;&#x4E8E;&#x5982;&#x4E0B;&#x5934;&#x6587;&#x4EF6;&#x4E2D;&#xFF1A;</p>
<pre><code>include/linux/unistd.h                
+-  arch/x86/include/asm/unistd.h
    +-  arch/x86/include/asm/unistd_32.h
    |   +-  ...
    |   +-  #define __NR_process_vm_writev  348
    |   +-  #define NR_syscalls             349
    +-  arch/x86/include/asm/unistd_64.h
        +-  ...
        +-  #define __NR_process_vm_writev  311
        +-  __SYSCALL(__NR_process_vm_writev, sys_process_vm_writev)
</code></pre><p>&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x4EC5;&#x9700;&#x5305;&#x542B;&#x5934;&#x6587;&#x4EF6;<code>#include &lt;unistd.h&gt;</code>&#x5373;&#x53EF;&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> _LINUX_UNISTD_H_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _LINUX_UNISTD_H_</span>

<span class="hljs-comment">/*
 * Include machine specific syscall numbers
 */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;asm/unistd.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span> <span class="hljs-comment">/* _LINUX_UNISTD_H_ */</span></span>
</code></pre>
<p>&#x5BF9;&#x4E8E;x86&#x800C;&#x8A00;&#xFF0C;<code>asm/unistd.h</code>&#x5373;&#x4E3A;<code>arch/x86/include/asm/unistd.h</code>:</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __KERNEL__</span>
<span class="hljs-meta">#  <span class="hljs-meta-keyword">ifdef</span> CONFIG_X86_32</span>
<span class="hljs-meta">#    <span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;unistd_32.h&quot;</span></span>
<span class="hljs-meta">#  <span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#    <span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;unistd_64.h&quot;</span></span>
<span class="hljs-meta">#  <span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#  <span class="hljs-meta-keyword">ifdef</span> __i386__</span>
<span class="hljs-meta">#    <span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;unistd_32.h&quot;</span></span>
<span class="hljs-meta">#  <span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta">#    <span class="hljs-meta-keyword">include</span> <span class="hljs-string">&quot;unistd_64.h&quot;</span></span>
<span class="hljs-meta">#  <span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

&#x5BF9;&#x4E8E;x86 <span class="hljs-number">32</span>-bit&#x800C;&#x8A00;&#xFF0C;unistd_32.h&#x5373;&#x4E3A;arch/x86/include/<span class="hljs-keyword">asm</span>/unistd_32.h:
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_restart_syscall        0</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_exit            1</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_fork            2</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_read            3</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_write            4</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_open            5</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_close            6</span>
...
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_process_vm_readv        347</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_process_vm_writev        348</span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> __KERNEL__</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NR_syscalls            349</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
</code></pre>
<h2 id="&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x8FD4;&#x56DE;&#x503C;">&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x8FD4;&#x56DE;&#x503C;</h2>
<p>&#x5982;&#x679C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x6267;&#x884C;&#x5931;&#x8D25;&#xFF0C;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5E76;&#x4E0D;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x9519;&#x8BEF;&#x7801;&#xFF0C;&#x800C;&#x662F;&#x5C06;&#x9519;&#x8BEF;&#x7801;&#x4FDD;&#x5B58;&#x5230;&#x5168;&#x5C40;&#x53D8;&#x91CF;<code>errno</code>&#x4E2D;&#xFF0C;&#x56E0;&#x800C;&#x53EF;&#x6839;&#x636E;<code>errno</code>&#x7684;&#x503C;&#x6765;&#x786E;&#x5B9A;&#x9519;&#x8BEF;&#x7C7B;&#x578B;&#x3002;&#x9519;&#x8BEF;&#x7801;&#x5B9A;&#x4E49;&#x4E8E;&#x5982;&#x4E0B;&#x5934;&#x6587;&#x4EF6;&#x4E2D;&#xFF1A;</p>
<pre><code>include/linux/errno.h                // &#x9519;&#x8BEF;&#x7801;512-530
-&gt; arch/x86/include/asm/errno.h            // &#x4EC5;&#x5305;&#x542B;asm-generic/errno.h&#xFF0C;&#x672A;&#x65B0;&#x589E;&#x9519;&#x8BEF;&#x7801;
   -&gt; include/asm-generic/errno.h        // &#x9519;&#x8BEF;&#x7801;35-133
      -&gt; include/asm-generic/errno-base.h    // &#x9519;&#x8BEF;&#x7801;1-34
</code></pre><p>&#x4E5F;&#x53EF;&#x4EE5;&#x6267;&#x884C;<code>man errno</code>&#x67E5;&#x8BE2;&#x5230;&#x3002;</p>
<h2 id="&#x65B0;&#x589E;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;">&#x65B0;&#x589E;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</h2>
<h3 id="&#x901A;&#x8FC7;&#x4FEE;&#x6539;&#x5185;&#x6838;&#x4EE3;&#x7801;">&#x901A;&#x8FC7;&#x4FEE;&#x6539;&#x5185;&#x6838;&#x4EE3;&#x7801;</h3>
<ul>
<li>&#x786E;&#x5B9A;&#x65B0;&#x589E;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;<ol>
<li>&#x4FEE;&#x6539;arch/x86/include/asm/unistd_32.h&#xFF0C;&#x4E3A;&#x65B0;&#x589E;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5B9A;&#x4E49;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;<code>#define _NR_testsyscall 350</code></li>
<li>&#x4FEE;&#x6539;arch/x86/kernel/syscall_table_32.S&#xFF0C;&#x5C06;&#x65B0;&#x589E;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x52A0;&#x5165;&#x5230;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x8868;&#xFF0C;&#x5373;&#x6570;&#x7EC4;sys_call_table&#x4E2D;&#x5199;&#x5165;&#xFF1A;<code>long sys_testsyscall  /* 350 */</code></li>
</ol>
</li>
<li>&#x7F16;&#x5199;&#x65B0;&#x589E;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;
&#x7F16;&#x5199;&#x4E00;&#x4E2A;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x610F;&#x5473;&#x7740;&#x8981;&#x7ED9;&#x5185;&#x6838;&#x589E;&#x52A0;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#xFF0C;&#x5C06;&#x8BE5;&#x51FD;&#x6570;&#x5199;&#x5165;&#x6587;&#x4EF6;kernel/sys.c&#x4E2D;&#xFF0C;&#x4EE3;&#x7801;&#x5982;&#x4E0B;&#xFF1A;<pre><code class="lang-c">SYSCALL_DEFINE0(testsyscall)
{
      console_print(<span class="hljs-string">&quot;hello world\n&quot;</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
</li>
<li>&#x4F7F;&#x7528;&#x65B0;&#x589E;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;
&#x56E0;&#x4E3A;C&#x5E93;&#x4E2D;&#x6CA1;&#x6709;&#x65B0;&#x589E;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x7A0B;&#x5E8F;&#x6BB5;&#xFF0C;&#x5FC5;&#x987B;&#x81EA;&#x5DF1;&#x5EFA;&#x7ACB;&#x5176;&#x4EE3;&#x7801;&#xFF0C;&#x5982;&#x4E0B;&#xFF1A;<pre><code class="lang-c"><span class="hljs-meta">#inculde &lt;syscalls.h&gt;</span>
SYSCALL_DEFINE0(testsyscall)
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>
</span>{
    tsetsyscall();
}
</code></pre>
</li>
</ul>
<h3 id="&#x901A;&#x8FC7;&#x7F16;&#x5199;&#x63D2;&#x5165;&#x5185;&#x6838;&#x6A21;&#x5757;">&#x901A;&#x8FC7;&#x7F16;&#x5199;&#x63D2;&#x5165;&#x5185;&#x6838;&#x6A21;&#x5757;</h3>
<ul>
<li><p>&#x7F16;&#x5199;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x5185;&#x6838;&#x6A21;&#x5757;</p>
<pre><code class="lang-c">  <span class="hljs-meta">#inculde &lt;linux/kernel.h&gt;</span>
  <span class="hljs-meta">#inculde &lt;linux/module.h&gt;</span>
  <span class="hljs-meta">#inculde &lt;linux/modversions.h&gt;</span>
  <span class="hljs-meta">#inculde &lt;linux/sched.h&gt;</span>
  <span class="hljs-meta">#inculde &lt;asm/uaccess.h&gt;</span>

  <span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> _NR_testsyscall 350</span>

  <span class="hljs-keyword">extern</span> <span class="hljs-keyword">void</span> *sys_call_table[];

  <span class="hljs-function">asmlinkage <span class="hljs-keyword">long</span> <span class="hljs-title">testsyscall</span><span class="hljs-params">()</span>
  </span>{
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;hello world\n&quot;</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  }

  <span class="hljs-function"><span class="hljs-keyword">int</span>  <span class="hljs-title">syscall_test_init</span><span class="hljs-params">()</span>
  </span>{
      sys_call_table[_NR_tsetsyscall] = testsyscall;
      <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;system call testsyscall() loaded success\n&quot;</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
  }
  module_init(syscall_test_init);

  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">syscall_test_exit</span><span class="hljs-params">()</span>
  </span>{
  }
  module_exit(syscall_test_exit)
</code></pre>
</li>
<li>&#x7F16;&#x5199;&#x4F7F;&#x7528;&#x65B0;&#x589E;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x7684;&#x4EE3;&#x7801;</li>
<li>&#x7F16;&#x8BD1;&#x5185;&#x6838;&#x6A21;&#x5757;&#x5E76;&#x63D2;&#x5165;&#x5185;&#x6838;&#x6A21;&#x5757;</li>
</ul>
<h2 id="&#x4ECE;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;">&#x4ECE;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;</h2>
<p>&#x65B9;&#x5F0F;&#x4E00;&#xFF1A;&#x901A;&#x8FC7;C&#x5E93;&#x51FD;&#x6570;&#xFF0C;C&#x5E93;&#x51FD;&#x6570;&#x5C01;&#x88C5;&#x4E86;&#x6240;&#x6709;&#x7684;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x65B9;&#x5F0F;&#x4E8C;&#xFF1A;2.6.18&#x7248;&#x672C;&#x4E4B;&#x524D;&#x7684;&#x5185;&#x6838;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>_syscall</code>&#x5B8F;&#x3002;&#x4F46;&#x662F;&#x81EA;2.6.19&#x7248;&#x672C;&#x5F00;&#x59CB;&#xFF0C;<code>_syscall</code>&#x5B8F;&#x88AB;&#x5E9F;&#x9664;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4F7F;&#x7528;<code>syscall</code>&#x51FD;&#x6570;&#xFF0C;&#x901A;&#x8FC7;&#x6307;&#x5B9A;<code>&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;</code>&#x548C;&#x4E00;&#x7EC4;&#x53C2;&#x6570;&#x6765;&#x8C03;&#x7528;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x3002;</p>
<pre><code class="lang-c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span> </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/syscall.h&gt;</span> </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span> </span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> __NR_gettid      224  </span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span>  
</span>{  
    <span class="hljs-keyword">pid_t</span> tid;  

    tid = syscall(__NR_gettid);  <span class="hljs-comment">//&#x62EC;&#x53F7;&#x5185;&#x53C2;&#x6570;&#x76F4;&#x63A5;&#x5199;224&#x4E5F;&#x53EF;&#x4EE5;</span>
    <span class="hljs-comment">/*&#x4E5F;&#x53EF;&#x4EE5;&#x5199;&#x6210;tid = syscall(SYS_gettid);*/</span>
}
</code></pre>
<p><a href="https://www.jianshu.com/p/5e96fd50f3b5" target="_blank">&#x53C2;&#x8003;</a></p>
<blockquote>
<p>&#x6CE8;&#xFF1A; syscall()&#x51FD;&#x6570;&#x662F;glibc&#x4E2D;&#x7684;&#x4E00;&#x4E2A;&#x7528;&#x6237;&#x7A7A;&#x95F4;&#x51FD;&#x6570;&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>man syscall</code>&#x547D;&#x4EE4;&#x67E5;&#x770B;&#xFF0C;&#x51FD;&#x6570;&#x58F0;&#x660E;&#x5728;/usr/include/unistd.h&#x4E2D;&#xFF0C;&#x5BF9;&#x5E94;&#x7CFB;&#x7EDF;&#x8C03;&#x7528;&#x53F7;&#x5728;/usr/include/asm-generic/unistd.h&#x4E2D;&#x58F0;&#x660E;&#x3002;</p>
</blockquote>
<footer class="page-footer"><span class="copyright">Copyright &#xA9; Yuanye.Ma 2020-2021 all right reserved&#xFF0C;powered by Gitbook</span><span class="footer-modification">&#x6587;&#x4EF6;&#x4FEE;&#x8BA2;&#x65F6;&#x95F4;&#xFF1A;
2023-04-02 10:05:52
</span></footer>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="submit-patch.html" class="navigation navigation-prev " aria-label="Previous page: Submit Patch">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="x86平台通用中断.html" class="navigation navigation-next " aria-label="Next page: x86平台通用中断">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"x86平台linux系统调用","level":"1.2.5.11","depth":3,"next":{"title":"x86平台通用中断","level":"1.2.5.12","depth":3,"path":"_posts/OS/x86平台通用中断.md","ref":"_posts/OS/x86平台通用中断.md","articles":[]},"previous":{"title":"Submit Patch","level":"1.2.5.10","depth":3,"path":"_posts/OS/submit-patch.md","ref":"_posts/OS/submit-patch.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","-search","-lunr","search-pro","pageview-count","page-toc-button","back-to-top-button","tbfed-pagefooter"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright &copy Yuanye.Ma 2020-2021","modify_label":"文件修订时间：","modify_format":"YYYY-MM-DD HH:mm:ss"},"page-toc-button":{"maxTocDepth":2,"minTocSize":2},"search-pro":{},"pageview-count":{},"back-to-top-button":{},"highlight":{},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Yuanye Ma","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Yuanye Ma`s blog","gitbook":"*","description":"Blog for Yuanye.Ma"},"file":{"path":"_posts/OS/x86平台linux系统调用.md","mtime":"2023-04-02T10:05:52.105Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2023-04-02T10:06:51.106Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search-pro/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-pageview-count/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-page-toc-button/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

